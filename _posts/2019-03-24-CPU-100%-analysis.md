---
layout: post
title: CPU使用率过高分析及优化
categories: [Linux]
---

> 破山中贼易，破心中贼难

前面的两篇文章主要介绍了系统的[平均负载]([http://blog.linyimin.club/load-average.html](http://blog.linyimin.club/blog/load-average.html))和[CPU上下文切换](http://blog.linyimin.club/blog/cpu-context-switching.html)。但是实际上我们更常用CPU使用率来描述系统的CPU性能。

CPU使用率是单位时间内CPU使用情况的统计，然后以百分比的方式进行展示，前面我们使用的`top`, `mpstat`, `pidstat`, `ps`等命令都可以查看CPU使用率。下面主要介绍一下不同场景的CPU使用率的具体含义，相关场景CPU使用率的计算及通过一个案例，学习在CPU使用率过高时，如何进行分析，然后进行相关优化。

## CPU使用率

我们知道，Linux作为一个多任务操作系统，将每个CPU时间划分成很短的时间片段，再通过调度器轮流分配给各个任务使用，造成多任务同时运行的错觉。

Linux使用节拍率(HZ)来维护CPU时间，每次触发时间中断，Jiffies变量会加一。`Jiffies`是一个全局变量，记录的是开机以来的节拍数。我们可以通过查询`/boot/config-$(uname -r)`内核文件来查看节拍率, 可以看到我主机的节拍率是250HZ，也就是每秒会触发250次时间中断。

```shell
$ grep '' /boot/config-$(uname -r)
```

![节拍率](http://blog.linyimin.club/images/posts/config-hz.png)

但是由于节拍率是内核选项参数，用户空间不能直接访问。为了方便用户空间程序，内核提供一个用户空间的节拍率USER_HZ,USER_HZ总是等于100，也就是1/100秒。


## 不同场景的CPU使用率含义

使用`mpstat`命令，我们发现一共存在10中场景下的CPU使用率。

![不同场景的CPU使用率含义](htpp://blog.linyimin.club/images/posts/mpstat.png)
  
下面主要介绍一下几个常用的场景:

- user(us, usr): 表示用户态时间。不包括nice时间
- nice(ni): 表示低优先级用户态时间.
- system(sys): 内核态CPU时间
- idle: 空闲时间。不包含等待IO时间(iowait)
- iowait(wa): 等待IO的CPU时间
- irq(hi): 处理硬件中断的CPU时间
- sofirq(si): 处理软中断的CPU时间

## CPU使用率的计算公式

我们可以通过查看`/proc/stat`文件查看相关的CPU时间信息

```shell
$ cat /proc/stat
``` 

![CPU时间信息](http://blog.linyimin.club/images/posts/proc-stat-cpu.png)

通过`man proc`查看相关类字段说明

```shell
$ man proc
```

![CPU时间信息说明](http://blog.linyimin.club/images/posts/cpu-time-info.png)

根据说明，我们可以知道，这些数值的单位是100HZ，以及各个场景的CPU时间(开机以来的总时间)

根据这些数据，我们可以很轻易的算出各个场景的平均CPU使用率。

<font color="#dd0000">平均CPU使用率 = $$1- \frac{空闲时间(idle)}{总CPU时间}$$</font>


## 参考链接

[极客时间-基础篇：某个应用的CPU使用率居然达到100%，我该怎么办？](https://time.geekbang.org/column/article/70476)

[在Linux下做性能分析3：perf](https://zhuanlan.zhihu.com/p/22194920)


