---
laout: post
title: Shell下多进程控制
categories: Linux
---

> 管它什么真理无穷, 进一步有一步的欢喜

## Shell下多进程控制

在shell脚本中，我们想要实现多进程高并发，最简单的方法是把命令丢到后台去，如果量不大的话，没问题。 但是如果有几百个进程同一时间丢到后台去就很恐怖了，对于服务器资源的消耗非常大，甚至导致宕机。

为了控制运行在后台的进程数量,我们引入管道,使用管道的性质完成并发进程数的控制.

### Linux管道

管道的特点: 

1. 如果管道中没有数据,那么从管道中取数据操作会被阻塞,直到管道内写入数据
2. 写入管道操作没有读取操作,写入操作也会被阻塞,直到管道数据被读出

#### 匿名管道

1. 由shell自动创建,存在内核中
2. 单向字节流

我们经常使用的`|`就是管道,例如`cat text | grep abc`, 直接作为两个进程的数据通道.

#### 命名管道(FIFO: First In First Out)

1. 在文件系统中,`FIFO`拥有名称,存在文件系统中,以设备特殊文件的形式存在
2. 双向字节流

`mkfifo`命令可以创建一个管道,例如`mkfifo fifo_file`.

![](images/mkfifo.png)

**向管道中写入数据**

```
$ cat "data" > fifo_file
```

上述命令表示我们想向管道文件中写入数据`data`,由于没有任何进程对它进行读操作,所以进程一直被阻塞.

**从管道中读取数据**

```
$ cat fifo_file
```

上述命令表示我们想从管道文件`fifo_file`中读取文件,此时写进程完成并退出, 并在终端上打印管道文件中的数据`data`.

### 文件描述符

文件描述符（缩写fd）在形式上是一个非负整数。实际上，它是一个索引值，指向内核中为每一个进程所维护的该进程打开文件的记录表。Linux下读写文件都是通过文件描述符完成的.

每个用户的文件描述符数目是受内核限制的,我们可以通过`ulimit`命令查看:

```shell
ulimit -n
```

1. 使用`exec`命令为文件自定义并绑定文件描述符(打开fifo_file文件,并将文件描述符设为100)

```shell
exec 100<>fifo_file
```

上述命令表示将文件fifo_file的读写操作绑定到文件描述符100上, 通过对文件描述符100的读写实际上就是对文件fifo_file的读写.

2. `>name`表示将输出重定向到文件`name`
3. `>&number`表示将输出重定向到文件描述符`number`


### 代码实现

```shell
#!/bin/bash
# 当按下CTRL+C快捷键退出时, 关闭文件描述符的读写操作
trap "exec 1000>&-; exec 1000<&-;exit 0" 2
# 创建命名管道
mkfifo mulfifo

# 将文件描述符1000和管道文件绑定
exec 1000<>mulfifo

rm -rf mulfifo

# 并发量为10,用这个数字来控制并发数
for ((n=1;n<=10;n++))
do
  # 写一个空行到管道文件中, 因为管道文件的读取以行为单位
  echo >&1000
done

start=`date +%s`

# 100个进程, 每次并发运行10个
for ((i=1;i<=100;i++))
do
    # 从管道文件中读取一行数据(可以读取10次, 读取10次之后再读,由于管道中没有数据, 会被阻塞,达到控制并发进程数的目的)
    read -u1000
    # 将进程任务扔到后台运行
    {
      echo success$i;sleep 3
      # 每个进程运行完成时,需要写一个空行数据到管道中, 唤醒读操作阻塞的进程
      echo >&1000
    }& # 需要放到后台运行,否则无法实现并发
done
# 等待上述所有操作(包括后台进程)运行完成, 再继续执行下面的操作
wait

end=`date +%s`
echo "Time :`expr $end - $start`"
# 关闭文件描述符的写操作
exec 1000>&-
# 关闭文件描述符的读操作
exec 1000<&- 
```

### 参考链接

[shell中的多进程【并发】](https://blog.51cto.com/fuwenchao/1564573)
[linux shell命名管道FIFO（多进程动态并发）](https://blog.csdn.net/qq_32642039/article/details/78624210)